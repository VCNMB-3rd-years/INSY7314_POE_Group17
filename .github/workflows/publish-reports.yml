name: Publish Security Reports

on:
  workflow_run:
    workflows: 
      - "NPM Audit Security Scan"
      - "Docker Security Scan"
      - "CodeQL Security Analysis - International Payments Portal"
    types:
      - completed

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: List JSON files
        run: |
          ls -la ./security-web/data || echo "Data folder not found"

      # --- Validate JSON data ---
      - name: Validate JSON data
        run: |
          mkdir -p ./security-web/data
          if [ -d ./security-web/data ]; then
            for f in ./security-web/data/*.json; do
              if [ -f "$f" ]; then
                echo "Validating $f"
                jq . "$f" > tmp.json && mv tmp.json "$f"
              fi
            done
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20



      - name: Ensure folders exist and create placeholder
        run: |
          mkdir -p ./security-web/data
          touch ./security-web/index.html

      # --- Generate static site ---
      - name: Generate static site
        run: node ./scripts/generate-site.js

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./security-web/*

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
