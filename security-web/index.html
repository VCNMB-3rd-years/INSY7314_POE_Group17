<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="report.css">
</head>

<body>
    <div class="container">
        <div class="header-tile">
            <h1>Security Analysis Dashboard</h1>
            <div class="subtitle">International Payments Portal - Real-time Security Monitoring</div>
            <div class="timestamp" id="timestamp">Loading...</div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-tile">
                <div class="metric-label">Total Vulnerabilities</div>
                <div class="metric-value" id="totalVulns">-</div>
                <div class="metric-subtitle">Across all scans</div>
            </div>
            <div class="metric-tile">
                <div class="metric-label">Critical Issues</div>
                <div class="metric-value critical" id="criticalCount">-</div>
                <div class="metric-subtitle">Immediate action required</div>
            </div>
            <div class="metric-tile">
                <div class="metric-label">High Priority</div>
                <div class="metric-value high" id="highCount">-</div>
                <div class="metric-subtitle">Address urgently</div>
            </div>
            <div class="metric-tile">
                <div class="metric-label">Scan Status</div>
                <div class="metric-value"><span class="status-dot status-active"></span>Active</div>
                <div class="metric-subtitle">Last updated: Now</div>
            </div>
        </div>

        <!-- Workflow Scan Summary -->
        <div class="scan-grid" id="scanGrid">
            <div class="loading">Loading security scans...</div>
        </div>

        <!-- Top Vulnerabilities -->
        <div class="details-tile" id="topVulnerabilities" style="display:none;">
            <div class="scan-header">
                <span class="scan-title">Top Critical Vulnerabilities & Insights</span>
            </div>
            <div id="topVulnsList"></div>
        </div>

        <!-- Comparative Analysis Chart -->
        <div class="chart-container">
            <h3>Vulnerability Severity Comparison</h3>
            <canvas id="comparisonChart"></canvas>
        </div>

    </div>

    <script>
        let allData = {};
        let charts = {};

        // --- Fetch JSON ---
        async function fetchJSON(file) {
            try {
                const res = await fetch('./data/' + file);
                if (!res.ok) throw new Error(`${file} fetch failed`);
                return await res.json();
            } catch (err) { console.error(err); return null; }
        }


        function groupVulnerabilitiesBySeverity(vulnerabilities) {
            const groups = { CRITICAL: [], HIGH: [], MEDIUM: [], LOW: [] };
            if (!vulnerabilities) return groups;
            vulnerabilities.forEach(v => {
                const sev = v.severity?.toUpperCase() || 'LOW';
                if (!groups[sev]) groups[sev] = [];
                groups[sev].push(v);
            });
            return groups;
        }




        // --- Data Processors ---
        function processNPMAudit(data) {
            if (!data || !data.vulnerabilities) return null;
            const vulns = Object.values(data.vulnerabilities);
            const severityCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
            vulns.forEach(v => {
                const s = (v.severity || 'UNKNOWN').toUpperCase();
                if (severityCounts[s] !== undefined) severityCounts[s]++;
            });
            return { severityCounts, vulnerabilities: vulns };
        }

        function processTrivyReport(data) {
            if (!data || !data.Results) return null;
            const severityCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
            const vulnerabilities = [];
            data.Results.forEach(r => {
                (r.Vulnerabilities || []).forEach(v => {
                    const s = (v.Severity || 'UNKNOWN').toUpperCase();
                    if (severityCounts[s] !== undefined) severityCounts[s]++;
                    vulnerabilities.push({ id: v.VulnerabilityID, severity: s, package: v.PkgName, version: v.InstalledVersion, fixed: v.FixedVersion, title: v.Title, description: v.Description });
                });
            });
            return { severityCounts, vulnerabilities };
        }

        function processCodeQL(data) {
            if (!data || !data.runs) return null;
            const severityCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0 };
            const vulnerabilities = [];
            data.runs.forEach(run => {
                (run.results || []).forEach(r => {
                    let s = 'LOW';
                    if (r.level === 'error') s = 'CRITICAL';
                    else if (r.level === 'warning') s = 'MEDIUM';
                    severityCounts[s]++;
                    vulnerabilities.push({ id: r.ruleId, severity: s, title: r.message?.text, location: r.locations?.[0]?.physicalLocation?.artifactLocation?.uri });
                });
            });
            return { severityCounts, vulnerabilities };
        }

        // --- Render Functions ---
        function createMiniChart(canvasId, data) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return null;
            if (charts[canvasId]) charts[canvasId].destroy();
            const chart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Critical', 'High', 'Medium', 'Low'], datasets: [{ data: [data.CRITICAL || 0, data.HIGH || 0, data.MEDIUM || 0, data.LOW || 0], backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#16a34a'], borderWidth: 0 }] } });
            charts[canvasId] = chart;
        }

        function renderScanTile(id, badge, badgeClass, title, data, vulnerabilities) {
            const canvasId = 'chart-' + id;
            const vulnContainerId = 'vuln-list-' + id;
            return `
            <div class="scan-tile">
                <div class="scan-header">
                    <span class="scan-badge ${badgeClass}">${badge}</span>
                    <span class="scan-title">${title}</span>
                </div>
                <div class="scan-content">
                    <canvas id="${canvasId}" class="chart-mini"></canvas>
                    <div class="severity-list">
                        <div class="severity-item critical"><span class="severity-name">Critical</span><span class="severity-count critical">${data.CRITICAL || 0}</span></div>
                        <div class="severity-item high"><span class="severity-name">High</span><span class="severity-count high">${data.HIGH || 0}</span></div>
                        <div class="severity-item medium"><span class="severity-name">Medium</span><span class="severity-count medium">${data.MEDIUM || 0}</span></div>
                        <div class="severity-item low"><span class="severity-name">Low</span><span class="severity-count low">${data.LOW || 0}</span></div>
                    </div>

                    <!-- Sorting controls -->
                    <div class="vuln-sort">
                        Sort by: 
                        <select id="sort-${id}">
                            <option value="severity">Severity</option>
                            <option value="package">Package</option>
                            <option value="id">ID</option>
                        </select>
                    </div>

                    <!-- Full vulnerability list -->
                    <div class="vuln-full-list" id="${vulnContainerId}">
                        ${renderVulnerabilityListHTML(vulnerabilities)}
                    </div>
                </div>
                <div class="scan-insight">
                    <strong>Insight:</strong> ${generateInsight(id)}
                </div>
            </div>`;
        }


        function generateInsight(id) {
            // Provide meaningful insights per workflow
            if (id === 'npm') return "High number of dependency vulnerabilities detected. Update packages regularly and run `npm audit fix`.";
            if (id === 'backend') return "Backend Docker images contain outdated packages. Consider rebuilding images with latest base images.";
            if (id === 'client') return "Frontend images contain vulnerable dependencies. Review package.json and rebuild.";
            if (id === 'codeql') return "CodeQL detected potential code-level issues. Review critical findings in source code.";
            return "No insight available";
        }

        function updateMetrics() {
            let total = 0, crit = 0, high = 0;
            Object.values(allData).forEach(d => {
                if (d && d.severityCounts) {
                    total += Object.values(d.severityCounts).reduce((a, b) => a + b, 0);
                    crit += d.severityCounts.CRITICAL || 0;
                    high += d.severityCounts.HIGH || 0;
                }
            });
            document.getElementById('totalVulns').textContent = total;
            document.getElementById('criticalCount').textContent = crit;
            document.getElementById('highCount').textContent = high;
        }

        function renderTopVulnerabilities() {
            const allVulns = [];
            Object.entries(allData).forEach(([source, d]) => {
                if (d && d.vulnerabilities) d.vulnerabilities.forEach(v => allVulns.push({ ...v, source }));
            });
            const top = allVulns.filter(v => v.severity === 'CRITICAL' || v.severity === 'HIGH').slice(0, 5);
            if (top.length === 0) { document.getElementById('topVulnerabilities').style.display = 'none'; return; }
            document.getElementById('topVulnerabilities').style.display = 'block';
            const html = top.map(v => `
        <div class="vuln-compact ${v.severity.toLowerCase()}">
            <div class="vuln-compact-header">
                <span class="vuln-compact-title">${v.id || 'Unknown'} - ${v.title || 'No description'}</span>
                <span class="vuln-compact-badge">${v.severity}</span>
            </div>
            <div style="font-size:0.85em; color:#64748b;">
                ${v.package ? `Package: ${v.package}@${v.version || ''}` : ''}
                ${v.fixed ? ` | Fixed in: ${v.fixed}` : ''}
                ${v.location ? ` | Location: ${v.location}` : ''}
                <br>${v.description || ''}
            </div>
        </div>
    `).join('');
            document.getElementById('topVulnsList').innerHTML = html;
        }

        function renderComparativeChart() {
            const labels = ['Critical', 'High', 'Medium', 'Low'];
            const datasets = ['npm', 'backend', 'client', 'codeql'].map((src, index) => {
                const colors = ['#cb3837', '#2496ed', '#3cb371', '#9ca3af'];
                return {
                    label: src.toUpperCase(),
                    data: labels.map(l => allData[src]?.severityCounts[l] || 0),
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    borderWidth: 1
                };
            });
            const ctx = document.getElementById('comparisonChart')?.getContext('2d');
            if (!ctx) return;
            new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } } });
        }


        function renderVulnerabilityListHTML(vulnerabilities, sortBy = 'severity') {
            if (!vulnerabilities) return '';
            let vulns = [...vulnerabilities];

            // --- Sorting logic ---
            vulns.sort((a, b) => {
                if (sortBy === 'severity') {
                    const order = { 'CRITICAL': 1, 'HIGH': 2, 'MEDIUM': 3, 'LOW': 4 };
                    return (order[a.severity] || 5) - (order[b.severity] || 5);
                } else if (sortBy === 'package') {
                    return (a.package || '').localeCompare(b.package || '');
                } else if (sortBy === 'id') {
                    return (a.id || '').localeCompare(b.id || '');
                }
                return 0;
            });

            let html = '';
            ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'].forEach(sev => {
                const list = vulns.filter(v => v.severity === sev);
                if (!list.length) return;
                html += `<h4 class="severity-header severity-${sev.toLowerCase()}">${sev} (${list.length})</h4>`;
                html += list.map(v => `
                    <div class="vuln-item ${sev.toLowerCase()}">
                        <div class="vuln-header">
                            <span class="vuln-id">${v.id || 'Unknown'}</span>
                            <span class="vuln-severity severity-${sev.toLowerCase()}">${sev}</span>
                        </div>
                        <div class="vuln-details">
                            ${v.package ? `<strong>Package:</strong> ${v.package}<br>` : ''}
                            ${v.version ? `<strong>Version:</strong> ${v.version}<br>` : ''}
                            ${v.fixed ? `<strong>Fixed in:</strong> ${v.fixed}<br>` : ''}
                            ${v.title || v.description ? `<strong>Description:</strong> ${v.title || v.description}` : ''}
                        </div>
                    </div>
                `).join('');
            });
            return html;
        }

        function initializeSorting(vulnerabilitiesMap) {
            Object.keys(vulnerabilitiesMap).forEach(id => {
                const select = document.getElementById('sort-' + id);
                if (!select) return;
                select.addEventListener('change', (e) => {
                    const sortBy = e.target.value;
                    const containerId = 'vuln-list-' + id;
                    document.getElementById(containerId).innerHTML =
                        renderVulnerabilityListHTML(vulnerabilitiesMap[id], sortBy);
                });
            });
        }



        // --- Main Renderer ---
        async function renderReports() {
            allData = {
                npm: processNPMAudit(await fetchJSON('npm-audit.json')),
                backend: processTrivyReport(await fetchJSON('trivy-backend.json')),
                client: processTrivyReport(await fetchJSON('trivy-client.json')),
                codeql: processCodeQL(await fetchJSON('codeql-analysis.json'))
            };

            const vulnerabilitiesMap = {}; // to track each scan's vulns for sorting
            let html = '';

            ['npm', 'backend', 'client', 'codeql'].forEach(id => {
                if (!allData[id]) return;
                vulnerabilitiesMap[id] = allData[id].vulnerabilities || [];
                html += renderScanTile(id,
                    id.toUpperCase(),
                    'badge-' + id,
                    `${id.charAt(0).toUpperCase() + id.slice(1)} Vulnerabilities`,
                    allData[id].severityCounts,
                    vulnerabilitiesMap[id]
                );
            });

            document.getElementById('scanGrid').innerHTML = html;
            ['npm', 'backend', 'client', 'codeql'].forEach(id => {
                if (allData[id]) createMiniChart('chart-' + id, allData[id].severityCounts);
            });

            updateMetrics();
            renderTopVulnerabilities();
            renderComparativeChart();

            initializeSorting(vulnerabilitiesMap);
        }
        window.onload = renderReports;
    </script>
</body>

</html>